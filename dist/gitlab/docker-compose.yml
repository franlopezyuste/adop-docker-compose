version: '3'
services:
  gitlab-postgresql:
    container_name: gitlab-postgresql
    restart: always
    image: postgres:9.6.9-alpine
    networks: 
      - ${CUSTOM_NETWORK_NAME}
    expose:
      - "5432"
    environment:
      POSTGRES_USER: ${GITLAB_POSTGRES_USER}
      POSTGRES_PASSWORD: ${PASSWORD_POSTGRESQL}
      POSTGRES_DB: ${GITLAB_POSTGRES_DB}
    volumes:
      - gitlab_postgresql_data:/var/lib/postgresql:rw
    logging:
      driver: syslog
      options:
        syslog-address: "udp://${LOGSTASH_HOST}:25826"
        tag: "gitlab-postgresql"

  gitlab:
    container_name: gitlab
    restart: always
    image: accenture/adop-gitlab:0.1.1
    hostname: gitlab
    links:
      - gitlab-postgresql:postgresql
      - gitlab-redis:redis
    networks: 
      - ${CUSTOM_NETWORK_NAME}
    ports:
      - "8880:80"
      - "8822:22"
    expose:
      - "80"
      - "22"
    environment:
      INITIAL_ADMIN_USER: ${INITIAL_ADMIN_USER}
      INITIAL_ADMIN_PASSWORD: ${INITIAL_ADMIN_PASSWORD_PLAIN}
      JENKINS_USER: ${GITLAB_JENKINS_USERNAME}
      JENKINS_PASSWORD: ${PASSWORD_JENKINS}
      GITLAB_OMNIBUS_CONFIG: |
        external_url "${PROTO}://${TARGET_HOST}/gitlab"
        postgresql['enable'] = false
        gitlab_rails['db_username'] = "${GITLAB_POSTGRES_USER}"
        gitlab_rails['db_password'] = "${PASSWORD_POSTGRESQL}"
        gitlab_rails['db_host'] = "gitlab-postgresql"
        gitlab_rails['db_port'] = "5432"
        gitlab_rails['db_database'] = "${GITLAB_POSTGRES_DB}"
        gitlab_rails['db_adapter'] = 'postgresql'
        gitlab_rails['db_encoding'] = 'utf8'
        gitlab_rails['monitoring_whitelist'] = ['127.0.0.0/8', "${DOCKER_NETWORK_SUBNET_CIDR}", "${JENKINS_REMOTE_HOST}"]
        # Redis Configuration
        redis['enable'] = false
        gitlab_rails['redis_host'] = 'gitlab-redis'
        gitlab_rails['redis_port'] = '6379'
        # LDAP Configuration
        gitlab_rails['ldap_enabled'] = true
        gitlab_rails['ldap_servers'] = YAML.load <<-'EOS'
          main:
            label: 'LDAP'
            host: '${LDAP_HOST}'
            port: 389
            uid: 'uid'
            method: 'plain'
            bind_dn: '${LDAP_MANAGER_DN}'
            password: '${LDAP_PWD}'
            active_directory: true
            allow_username_or_email_login: false
            block_auto_created_users: false
            base: '${LDAP_FULL_DOMAIN}'
            signin_enabled: false
        EOS
    volumes:
      - gitlab_config:/etc/gitlab:rw
      - gitlab_logs:/var/log/gitlab:rw
      - gitlab_data:/var/opt/gitlab:rw
    logging:
      driver: syslog
      options:
        syslog-address: "udp://${LOGSTASH_HOST}:25826"
        tag: "gitlab"

  gitlab-redis:
    container_name: gitlab-redis
    restart: always
    image: redis:3.2.12-alpine
    networks: 
      - ${CUSTOM_NETWORK_NAME}
    expose:
      - "6379"
    volumes:
      - gitlab_redis_data:/data
    logging:
      driver: syslog
      options:
        syslog-address: "udp://${LOGSTASH_HOST}:25826"
        tag: "gitlab-redis"

volumes:
  gitlab_postgresql_data:
  gitlab_config:
  gitlab_logs:
  gitlab_data:
  gitlab_redis_data:

networks:
  local_network: