version: '3'
services:
  sonar-mysql:
    container_name: sonar-mysql
    restart: always
    image: mysql:5.6.25
    networks: 
      - ${CUSTOM_NETWORK_NAME}
    expose:
      - "3306"
    environment:
      MYSQL_ROOT_PASSWORD: ${PASSWORD_SQL}
      MYSQL_USER: ${SONAR_MYSQL_USER}
      MYSQL_PASSWORD: ${SONAR_MYSQL_PASSWORD}
      MYSQL_DATABASE: ${SONAR_MYSQL_DATABASE}
    volumes:
      - sonar_mysql_data:/var/lib/mysql
    logging:
      driver: syslog
      options:
        syslog-address: "udp://${LOGSTASH_HOST}:25826"
        tag: "sonar-mysql"

  sonar:
    container_name: sonar
    restart: always
    image: accenture/adop-sonar
    build: ./adop-sonar/
    networks: 
      - ${CUSTOM_NETWORK_NAME}
    ports:
      - "9000:9000"
    expose:
      - "9000"
    environment:
      - "dependency:container==sonar-mysql"
      - "SONARQUBE_JDBC_USERNAME=${SONAR_MYSQL_USER}"
      - "SONARQUBE_JDBC_PASSWORD=${SONAR_MYSQL_PASSWORD}"
      - "LDAP_URL=ldap://${LDAP_SERVER}"
      - "LDAP_BIND_DN=${LDAP_ADMIN},${LDAP_FULL_DOMAIN}"
      - "LDAP_BIND_PASSWORD=${LDAP_PWD}"
      - "LDAP_USER_BASE_DN=${LDAP_USER_BASE_DN},${LDAP_FULL_DOMAIN}"
      - "LDAP_USER_REQUEST=(&(objectClass=inetOrgPerson)(uid={login}))"
      - "LDAP_USER_REAL_NAME_ATTRIBUTE=displayName"
      - "LDAP_USER_EMAIL_ATTRIBUTE=mail"
      - "LDAP_GROUP_BASE_DN=${LDAP_GROUP_BASE_DN},${LDAP_FULL_DOMAIN}"
      - "LDAP_GROUP_REQUEST=(&(objectClass=groupOfUniqueNames)(uniqueMember={dn}))"
      - "LDAP_GROUP_ID_ATTRIBUTE=cn"
      - "SONARQUBE_JDBC_URL=jdbc:mysql://sonar-mysql:3306/${SONAR_MYSQL_DATABASE}?useUnicode=true&characterEncoding=utf8&rewriteBatchedStatements=true"
    volumes:
      - sonar_data:/opt/sonarqube/data
      - sonar_extensions:/opt/sonarqube/extensions 
      - sonar_logs:/opt/sonarqube/logs
    logging:
      driver: syslog
      options:
        syslog-address: "udp://${LOGSTASH_HOST}:25826"
        tag: "sonar"

volumes:
  sonar_mysql_data:
  sonar_data:
  sonar_extensions:
  sonar_logs:

networks:
  local_network:
